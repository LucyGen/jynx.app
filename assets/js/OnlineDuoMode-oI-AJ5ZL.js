import{N as t,G as e}from"./sync-game-CMiSMg4n.js";import{g as s}from"./logger-CHTAPRDI.js";import{G as i}from"./config-RBrWeKVX.js";import"./analytics-service-UCL_K60g.js";import"./firebase-vendor-yjSyvrsK.js";import"./vendor-BmBcEOuS.js";class n{constructor(t,e,i){this.gameManager=t,this.inputManager=e,this.firebaseSync=i,this.logger=s("OnlineDuoMode"),this.isActive=!1,this.isHost=!1,this.roomId=null,this.partnerId=null,this.partnerConnected=!1,this.latency=0,this.packetLoss=0,this.lastSyncTime=0,this.inputBuffer=[],this.maxInputBufferSize=10,this.stateHistory=[],this.maxStateHistorySize=60}async start(t,e=!1){this.logger.info(`Starting online duo mode - Room: ${t}, Host: ${e}`),this.isActive=!0,this.isHost=e,this.roomId=t,await this.setupFirebaseSync(),this.setupNetworkHandlers(),this.setupPredictedInput(),this.isHost||await this.waitForPartner(),await this.gameManager.startOnlineDuoGame(t),this.subscribeToGameEvents(),this.startSyncLoop()}async setupFirebaseSync(){if(!this.firebaseSync)throw new Error("Firebase sync service not available");await this.firebaseSync.connect(this.roomId),this.logger.info("Firebase sync connected")}setupNetworkHandlers(){this.firebaseSync&&(this.firebaseSync.on(t.CONNECTED,(t=>{this.handlePartnerConnected(t)})),this.firebaseSync.on(t.DISCONNECTED,(t=>{this.handlePartnerDisconnected(t)})),this.firebaseSync.on(t.STATE_SYNC,(t=>{this.handleStateSync(t)})),this.firebaseSync.on(t.INPUT_RECEIVED,(t=>{this.handlePartnerInput(t)})),this.firebaseSync.on(t.ERROR,(t=>{this.handleNetworkError(t)})),this.firebaseSync.on(t.PING,(t=>{this.updateLatency(t)})))}setupPredictedInput(){this.inputManager.on("jump",(t=>{if(!this.isActive)return;const{player:e}=t;this.applyLocalInput(t),this.sendInputToPartner(t),this.storeInput(t)}))}applyLocalInput(t){const{player:e,inputType:s}=t,i=Date.now();this.gameManager.handleJumpInput({player:e,inputType:s||"TOUCH",timestamp:i}),this.logger.debug("Local input applied (predicted)")}sendInputToPartner(t){this.firebaseSync&&this.partnerConnected&&this.firebaseSync.sendInput({player:t.player,timestamp:t.timestamp,type:t.inputType})}storeInput(t){this.inputBuffer.push({...t,acknowledged:!1}),this.inputBuffer.length>this.maxInputBufferSize&&this.inputBuffer.shift()}handlePartnerInput(t){const{player:e,timestamp:s,type:i}=t;this.logger.debug(`Partner input received: Player ${e}`),this.isHost||this.reconcileInput(t)}reconcileInput(t){const e=this.inputBuffer.findIndex((e=>e.timestamp===t.timestamp));-1!==e&&(this.inputBuffer[e].acknowledged=!0),this.inputBuffer=this.inputBuffer.filter((t=>!t.acknowledged||Date.now()-t.timestamp<1e3))}handleStateSync(t){this.isHost?this.logger.debug("Host ignoring state sync (authoritative)"):this.applyAuthoritativeState(t),this.lastSyncTime=Date.now()}applyAuthoritativeState(t){const{dots:e,obstacles:s,score:i,difficulty:n,timestamp:r}=t,a=Date.now()-r;this.logger.debug(`State sync latency: ${a}ms`),this.storeState(t)}storeState(t){this.stateHistory.push({...t,receivedAt:Date.now()}),this.stateHistory.length>this.maxStateHistorySize&&this.stateHistory.shift()}async waitForPartner(){return this.logger.info("Waiting for partner..."),new Promise(((e,s)=>{const n=setTimeout((()=>{s(new Error("Partner connection timeout"))}),i.MULTIPLAYER?.MATCHMAKING_TIMEOUT||3e4),r=()=>{this.partnerConnected&&(clearTimeout(n),e())};this.firebaseSync.on(t.CONNECTED,(()=>{r()}))}))}handlePartnerConnected(t){this.logger.info("Partner connected:",t),this.partnerConnected=!0,this.partnerId=t.playerId,this.gameManager.emit("partnerConnected",t)}handlePartnerDisconnected(t){this.logger.warn("Partner disconnected:",t),this.partnerConnected=!1,this.handleDisconnectFallback(),this.gameManager.emit("partnerDisconnected",t)}handleDisconnectFallback(){this.logger.info("Falling back to solo mode due to disconnect"),this.stop(),this.gameManager.pause(),this.gameManager.uiManager&&this.gameManager.uiManager.showDisconnectDialog()}handleNetworkError(t){this.logger.error("Network error:",t),this.packetLoss++,this.packetLoss>10&&(this.logger.error("Too many network errors, disconnecting"),this.handleDisconnectFallback())}updateLatency(t){this.latency=t.latency,this.latency>(i.MULTIPLAYER?.MAX_LATENCY||200)&&this.logger.warn(`High latency: ${this.latency}ms`)}startSyncLoop(){if(!this.isHost)return;const t=i.MULTIPLAYER?.SYNC_INTERVAL||50;this.syncLoopInterval=setInterval((()=>{this.isActive&&this.partnerConnected}),t)}stopSyncLoop(){this.syncLoopInterval&&(clearInterval(this.syncLoopInterval),this.syncLoopInterval=null)}subscribeToGameEvents(){this.gameManager.on("perfectSync",(t=>{this.logger.info("Perfect sync in online mode!"),this.firebaseSync&&this.firebaseSync.sendEvent("perfectSync",t)})),this.gameManager.on("gameOver",(t=>{this.handleGameOver(t)}))}handleGameOver(t){this.logger.info("Online duo game over",t),this.firebaseSync&&this.firebaseSync.submitScore({roomId:this.roomId,score:t.score,perfectSyncs:t.perfectSyncs,duration:t.duration}),this.stop()}stop(){this.logger.info("Stopping online duo game mode"),this.isActive=!1,this.stopSyncLoop(),this.firebaseSync&&this.firebaseSync.disconnect(),this.inputBuffer=[],this.stateHistory=[]}getStats(){return{mode:e.ONLINE,isHost:this.isHost,roomId:this.roomId,partnerId:this.partnerId,partnerConnected:this.partnerConnected,network:{latency:this.latency,packetLoss:this.packetLoss,lastSyncTime:this.lastSyncTime},buffers:{inputBufferSize:this.inputBuffer.length,stateHistorySize:this.stateHistory.length}}}getNetworkQuality(){return this.latency<50?"excellent":this.latency<100?"good":this.latency<200?"fair":"poor"}}export{n as OnlineDuoMode,n as default};
